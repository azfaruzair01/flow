<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Flow V18 (Material Ghost)</title>
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            hsbc: { red: '#db0011', dark: '#1e1e1e', panel: '#2d2d2d', border: '#404040' }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Menlo', 'Consolas', 'monospace'] }
        }
      }
    }
  </script>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e1e1e; }
    ::-webkit-scrollbar-thumb { background: #555; }
    body { background-color: #1e1e1e; color: #e5e7eb; }
    
    /* Mocking the icon class behavior for PlayCode preview purposes only */
    /* In your project, the plugin handles this. Here, I'll use a placeholder */
    [class^="icon-"] {
      display: inline-block;
      width: 1.2em;
      height: 1.2em;
      background-color: currentColor;
      mask-size: contain;
      mask-position: center;
      mask-repeat: no-repeat;
      vertical-align: text-bottom;
    }
    /* SVG Data URIs for the preview (Your project won't need this CSS) */
    .icon-\[material-symbols--data-object-outline\] { mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 20h20v-4h-2v2H4V6h16v2h2V4H2v16zm10-7.5c-1.1 0-2-.9-2-2s.9-2 2-2s2 .9 2 2s-.9 2-2 2z"/></svg>'); }
    .icon-\[material-symbols--label-outline\] { mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16zM16 17H5V7h11l3.55 5L16 17z"/></svg>'); }
    .icon-\[material-symbols--tune\] { mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>'); }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden font-sans antialiased text-sm">

<div id="app" class="flex flex-col h-full">

  <header class="bg-hsbc-panel border-b border-hsbc-border px-6 py-3 shrink-0 z-20 shadow-md">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-4">
        <div>
          <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold text-white tracking-tight">{{ store.transactionId }}</h1>
            <span class="font-bold uppercase tracking-wider text-xs" :class="statusColorText">
              {{ store.lastStatus }}
            </span>
          </div>
          <div class="text-gray-400 text-xs mt-0.5 font-mono">
            Started: {{ formatDateTime(store.rawSteps[0]?.timestamp) }}
          </div>
        </div>
      </div>
      <div class="flex gap-8 text-right">
        <div><div class="text-[10px] uppercase text-gray-500 font-semibold">Duration</div><div class="font-mono text-base font-medium text-white">{{ store.totalDuration }}</div></div>
        <div><div class="text-[10px] uppercase text-gray-500 font-semibold">Steps</div><div class="font-mono text-base font-medium text-white">{{ store.rawSteps.length }}</div></div>
      </div>
    </div>
  </header>

  <main class="flex-1 overflow-y-auto p-8 relative">
    <div class="max-w-6xl mx-auto">
      
      <div v-for="(step, index) in store.rawSteps" :key="index" class="flex gap-x-4 group">
        
        <div class="w-24 text-end pt-0.5 flex flex-col items-end">
          <span class="text-xs text-gray-500 font-mono leading-none" v-if="step.timestamp">
            {{ extractTime(step.timestamp) }}
          </span>
          <span class="h-4" v-else></span>
        </div>

        <div class="relative last:after:hidden after:absolute after:top-2 after:bottom-0 after:start-[6px] after:w-px after:bg-gray-700">
          <div class="relative z-10 flex justify-center items-center">
            <div class="w-3 h-3 rounded-full border-2 box-border cursor-help" 
                 :class="getDotClass(step.state)" 
                 :title="step.state">
            </div>
          </div>
        </div>

        <div class="grow pb-8 pt-0.5">
          
          <div class="flex items-center gap-3">
            <h3 class="text-sm font-bold text-gray-100 leading-none">
              {{ step.stepName }}
            </h3>
            
            <span v-if="step.outcome" class="text-xs text-gray-500 font-mono">
              — {{ step.outcome }}
            </span>
          </div>

          <div class="mt-1.5 flex flex-wrap gap-x-4 text-xs">
            
            <button v-if="step.payload && step.payload.length" 
              @click="openDrawer(step, 'Payload')"
              class="group flex items-center gap-1.5 px-1.5 py-1 rounded text-blue-400 hover:bg-[#252525] hover:text-blue-300 transition-colors">
              <span class="icon-[material-symbols--data-object-outline]"></span>
              <span class="font-medium">{{ step.payload.length }} Payloads</span>
            </button>

            <button v-if="getHeaderCount(step) > 0"
              @click="openDrawer(step, 'Headers')"
              class="group flex items-center gap-1.5 px-1.5 py-1 rounded text-purple-400 hover:bg-[#252525] hover:text-purple-300 transition-colors">
              <span class="icon-[material-symbols--label-outline]"></span>
              <span class="font-medium">+{{ getHeaderCount(step) }} Headers</span>
            </button>

            <button v-if="step.parameters && Object.keys(step.parameters).length > 0"
              @click="openDrawer(step, 'Parameters')"
              class="group flex items-center gap-1.5 px-1.5 py-1 rounded text-amber-400 hover:bg-[#252525] hover:text-amber-300 transition-colors">
              <span class="icon-[material-symbols--tune]"></span>
              <span class="font-medium">{{ Object.keys(step.parameters).length }} Params</span>
            </button>

          </div>

          <div v-if="step.error" class="mt-3">
            <div class="inline-block px-3 py-2 bg-red-950/40 border-l-2 border-hsbc-red text-xs text-red-200 font-mono rounded-r-sm">
              <span class="font-bold text-red-400 block mb-1">Error:</span>
              {{ step.error.message }}
            </div>
          </div>

        </div>
      </div>

    </div>
  </main>

  <div v-if="isDrawerOpen" class="fixed inset-0 z-50 flex justify-end">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-[1px]" @click="closeDrawer"></div>
    <div class="relative w-[700px] h-full bg-hsbc-panel border-l border-hsbc-border shadow-2xl flex flex-col rounded-none transform transition-transform">
      <div class="px-6 py-5 border-b border-hsbc-border bg-[#252525] flex justify-between items-start">
        <div>
          <h2 class="text-lg font-bold text-white">{{ selectedStep?.stepName }}</h2>
          <div class="text-xs text-gray-500 font-mono mt-1">ID: {{ selectedStep?.serviceName }}</div>
        </div>
        <button @click="closeDrawer" class="text-gray-400 hover:text-white p-1 hover:bg-gray-700 rounded">✕</button>
      </div>
      
      <div class="flex border-b border-hsbc-border bg-hsbc-panel px-6 pt-1 overflow-x-auto">
        <button v-for="tab in ['Payload', 'Headers', 'Parameters', 'Metadata']" :key="tab" @click="currentTab = tab" class="pb-3 px-4 text-xs font-bold uppercase tracking-wider border-b-2 transition-colors rounded-none outline-none focus:outline-none whitespace-nowrap" :class="currentTab === tab ? 'border-hsbc-red text-white' : 'border-transparent text-gray-500 hover:text-gray-300'">{{ tab }}</button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 bg-hsbc-dark">
        <div v-if="currentTab === 'Payload'" class="p-6 space-y-8">
          <div v-if="selectedStep?.payload?.length">
            <div v-for="(p, idx) in selectedStep.payload" :key="idx">
              <div class="flex justify-between items-center mb-2 pl-2 border-l-2 border-blue-500">
                <span class="text-xs font-bold text-blue-400 uppercase">{{ p.label }}</span>
                <span class="text-[10px] text-gray-500 bg-gray-800 px-2 py-0.5 rounded">{{ p.size }} bytes</span>
              </div>
              <div class="bg-[#111] p-4 border border-hsbc-border text-xs font-mono text-gray-300 overflow-x-auto">
                <pre v-if="p.data"><code>{{ JSON.stringify(p.data, null, 2) }}</code></pre>
                <div v-else class="text-gray-500 italic">// Metadata only{{ JSON.stringify(p.metadata, null, 2) }}</div>
              </div>
            </div>
          </div>
          <div v-else class="flex flex-col items-center justify-center h-64 text-gray-500"><span>No Payloads</span></div>
        </div>
        <div v-if="currentTab === 'Headers'" class="p-6">
          <div v-if="selectedStep?.headerDelta"><div class="bg-[#111] p-4 border border-hsbc-border text-xs font-mono text-gray-300 overflow-x-auto"><pre><code>{{ JSON.stringify(selectedStep.headerDelta, null, 2) }}</code></pre></div></div>
          <div v-else class="flex flex-col items-center justify-center h-64 text-gray-500"><span>No Header Changes</span></div>
        </div>
        <div v-if="currentTab === 'Parameters'" class="p-6">
          <div v-if="selectedStep?.parameters && Object.keys(selectedStep.parameters).length > 0">
             <div class="grid grid-cols-1 gap-px bg-hsbc-border border border-hsbc-border">
                <div v-for="(val, key) in selectedStep.parameters" :key="key" class="grid grid-cols-3 bg-[#1a1a1a]">
                   <div class="col-span-1 p-3 text-gray-500 text-xs font-bold border-r border-hsbc-border flex items-center bg-[#202020]">{{ key }}</div>
                   <div class="col-span-2 p-3 text-gray-300 text-xs font-mono break-all">{{ val }}</div>
                </div>
             </div>
          </div>
          <div v-else class="flex flex-col items-center justify-center h-64 text-gray-500"><span>No Parameters</span></div>
        </div>
        <div v-if="currentTab === 'Metadata'" class="p-6">
          <table class="w-full text-left text-xs border-collapse">
            <tbody>
              <tr class="border-b border-hsbc-border"><td class="py-3 text-gray-500 font-bold uppercase w-32">Status</td><td class="py-3 font-mono text-white">{{ selectedStep?.state }}</td></tr>
              <tr class="border-b border-hsbc-border"><td class="py-3 text-gray-500 font-bold uppercase">Outcome</td><td class="py-3 font-mono text-white">{{ selectedStep?.outcome || '-' }}</td></tr>
              <tr class="border-b border-hsbc-border"><td class="py-3 text-gray-500 font-bold uppercase align-top pt-3">Sequence</td><td class="py-3 font-mono text-gray-400 break-all leading-relaxed">{{ selectedStep?.sequence }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const { createApp, ref, reactive, computed, onMounted } = Vue;

  // --- MOCK DATA ---
  const rawData = {
    "transactionId": "542196fe-1f62-4ec8-a6b7-78043fc6bc3b",
    "steps": [
      { 
        step: 0, timestamp: "2025-12-03T16:38:34.173Z", state: "RECEIVED", 
        stepName: "pol-sms-sync-async-gateway", serviceName: "gateway", 
        payload: [{label: "INIT", size: 1200, data: {body: "init"}}] 
      },
      { 
        step: 2, timestamp: "2025-12-03T16:38:34.195Z", state: "SUCCESS", 
        stepName: "pol-sms-initiator-service", serviceName: "initiator",
        outcome: "PAYMENT_COMPLETE_SUCCESS",
        parameters: { "rule": "txn-report", "mode": "sync" },
        payload: [{label: "RULE", size: 192, data: {rule: "pass"}}]
      },
      { 
        step: 35, timestamp: "2025-12-03T16:38:34.436Z", state: "FAILED", 
        stepName: "Gateway Handshake", serviceName: "gateway",
        outcome: "CALL_WATCHDOG_FAILED",
        error: { message: "Error 504: Watchdog killed process." },
        payload: [{ label: "GATEWAY_ERR", size: 45, data: { code: "TIMEOUT" } }] 
      }
    ]
  };

  createApp({
    setup() {
      const store = reactive({ transactionId: rawData.transactionId, rawSteps: [], totalDuration: '0ms' });
      const selectedStep = ref(null);
      const isDrawerOpen = ref(false);
      const currentTab = ref('Payload');

      function processData() {
        store.rawSteps = rawData.steps;
        const valid = store.rawSteps.filter(s => s.timestamp);
        if(valid.length > 1) {
           const start = new Date(valid[0].timestamp).getTime();
           const end = new Date(valid[valid.length-1].timestamp).getTime();
           store.totalDuration = `${end - start}ms`;
        }
      }

      const successStates = ['SUCCESS', 'PAYMENT_COMPLETE_SUCCESS'];
      const failStates = ['FAILED', 'PAYMENT_COMPLETE_FAILED', 'CALL_FAILED', 'CALL_WATCHDOG_FAILED'];
      const warnStates = ['DEADLINE_PASSED', 'MAN_WAKEUP'];

      function getStateColor(state) {
        if(successStates.includes(state)) return 'text-green-500';
        if(failStates.includes(state)) return 'text-hsbc-red';
        if(warnStates.includes(state)) return 'text-amber-500';
        return 'text-gray-400';
      }

      function getDotClass(state) {
        if(successStates.includes(state)) return 'bg-green-500 border-green-500';
        if(failStates.includes(state)) return 'bg-hsbc-red border-hsbc-red';
        if(warnStates.includes(state)) return 'bg-amber-500 border-amber-500';
        return 'bg-gray-500 border-gray-500'; // Default is Grey (V17 Logic)
      }

      const statusColorText = computed(() => {
        const last = store.rawSteps[store.rawSteps.length - 1]?.state;
        return getStateColor(last);
      });

      function openDrawer(step, tab = 'Payload') { selectedStep.value = step; currentTab.value = tab; isDrawerOpen.value = true; }
      function closeDrawer() { isDrawerOpen.value = false; }
      function extractTime(iso) { return new Date(iso).toLocaleTimeString([], { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' }) + '.' + new Date(iso).getMilliseconds(); }
      function formatDateTime(iso) { if(!iso) return ''; return new Date(iso).toLocaleString(); }
      function getHeaderCount(step) { return step.headerDelta ? Object.keys(step.headerDelta).length : 0; }

      onMounted(() => processData());

      return { store, selectedStep, isDrawerOpen, currentTab, statusColorText, openDrawer, closeDrawer, extractTime, formatDateTime, getDotClass, getStateColor, getHeaderCount };
    }
  }).mount('#app');
</script>

</body>
</html>
